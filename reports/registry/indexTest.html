<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìã Registry Agent - Catalogue des agents</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
        /* ============================================================
           STYLES COMPLETS
           ============================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: #f5f7fa;
            min-height: 100vh;
            padding: 30px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #2d3748;
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-subtitle {
            margin-top: 10px;
            opacity: 0.9;
            font-size: 16px;
            color: #e2e8f0;
        }

        .btn-back {
            padding: 10px 20px;
            background: white;
            color: #2d3748;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(45, 55, 72, 0.1);
            border-color: #2d3748;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 13px;
        }

        .agent-tree {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }

        .agent-tree h2 {
            margin-bottom: 20px;
            color: #1a1e24;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #agents-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .agent-node {
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .agent-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #2d3748;
        }

        .agent-header:hover {
            background: #f1f5f9;
            transform: translateX(2px);
        }

        .agent-icon {
            font-size: 24px;
            margin-right: 15px;
            min-width: 40px;
            text-align: center;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name-line {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .agent-name {
            font-size: 18px;
            font-weight: 600;
            color: #1a1e24;
        }

        .agent-version {
            font-size: 12px;
            background: #e0e7ff;
            color: #2d3748;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .agent-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-beta {
            background: #fff3cd;
            color: #856404;
        }

        .agent-meta {
            display: flex;
            gap: 10px;
            font-size: 12px;
            color: #666;
            flex-wrap: wrap;
        }

        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }

        .badge-capability { background: #e0e7ff; color: #2d3748; }
        .badge-tool { background: #f3e8ff; color: #6b21a8; }
        .badge-output { background: #d1fae5; color: #065f46; }
        .badge-rule { background: #fff3cd; color: #856404; }
        .badge-dependency { background: #f3e8ff; color: #6b21a8; }
        .badge-subagent { background: #cbd5e1; color: #1e293b; }

        .expand-icon {
            font-size: 20px;
            color: #2d3748;
            transition: transform 0.3s;
            margin-left: 10px;
        }

        .agent-header.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .agent-detail {
            display: none;
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .agent-detail.visible {
            display: block;
        }

        .identity-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .identity-card h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1e24;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .identity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .identity-grid div {
            font-size: 13px;
        }

        .identity-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            display: block;
            margin-bottom: 2px;
        }

        .versions-dict {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e5e7eb;
        }

        .versions-dict h4 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1e24;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .versions-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .versions-table th {
            text-align: left;
            padding: 10px;
            background: #f8fafc;
            color: #2d3748;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .versions-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e5e7eb;
        }

        .versions-table tr:hover {
            background: #f1f5f9;
        }

        .version-current {
            background: #e0e7ff;
            color: #2d3748;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section h4 {
            font-size: 15px;
            font-weight: 600;
            color: #1a1e24;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-list {
            list-style: none;
            padding: 0;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 8px;
        }

        .detail-list li {
            padding: 6px 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            font-size: 12px;
            color: #333;
        }

        .dependencies-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .dependency-item {
            background: #f3e8ff;
            color: #6b21a8;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        /* Sous-agents compacts dans le d√©tail */
        .sub-agents-compact {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .compact-subagent {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }

        .compact-subagent .agent-header {
            border-left-width: 2px;
            border-left-color: #94a3b8;
            padding: 8px 12px;
            background: #f8fafc;
        }

        .compact-subagent .agent-header:hover {
            background: #f1f5f9;
        }

        .compact-subagent .agent-detail {
            background: #ffffff;
            border-top: 1px dashed #e5e7eb;
            padding: 12px;
        }

        .compact-subagent .identity-card {
            background: #f8fafc;
            padding: 10px;
            margin-bottom: 8px;
            border: none;
            box-shadow: none;
        }

        .compact-subagent .identity-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .compact-subagent h5 {
            font-size: 12px;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .compact-subagent .detail-list {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 5px;
            margin-bottom: 0;
        }

        .compact-subagent .detail-list li {
            font-size: 11px;
            padding: 4px 8px;
        }

        .sub-agents {
            margin-left: 40px;
            margin-top: 10px;
        }

        .loading, .error {
            text-align: center;
            padding: 50px;
            background: #f8fafc;
            border-radius: 12px;
            color: #666;
        }
        .error {
            color: #991b1b;
            background: #fee2e2;
            border: 1px solid #ef4444;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: #666;
            font-size: 13px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1><span>üìã</span> Registry Agent - Catalogue des agents</h1>
                <div class="header-subtitle" id="header-subtitle">Chargement...</div>
            </div>
            <a href="../index.html" class="btn-back">‚Üê Portail</a>
        </div>

        <div class="stats-grid" id="stats-container">
            <div class="stat-card"><div class="stat-value" id="stats-main-agents">0</div><div class="stat-label">Agents principaux</div></div>
            <div class="stat-card"><div class="stat-value" id="stats-sub-agents">0</div><div class="stat-label">Sous-agents</div></div>
            <div class="stat-card"><div class="stat-value" id="stats-capacities">0</div><div class="stat-label">Capacit√©s</div></div>
            <div class="stat-card"><div class="stat-value" id="stats-tools">0</div><div class="stat-label">Outils</div></div>
            <div class="stat-card"><div class="stat-value" id="stats-outputs">0</div><div class="stat-label">Outputs</div></div>
            <div class="stat-card"><div class="stat-value" id="stats-rules">0</div><div class="stat-label">R√®gles</div></div>
        </div>

        <div class="agent-tree">
            <h2>üå≥ Hi√©rarchie compl√®te des agents</h2>
            <div id="agents-container">
                <div class="loading">Chargement des agents...</div>
            </div>
        </div>

        <div class="footer">Registry Agent - Mise √† jour: <span id="last-update"></span></div>
    </div>

    <script>
        const AgentManager = {
            agents: { mainAgents: [] },

            iconMap: {
                'base_agent': 'üß¨',
                'architect': 'üèóÔ∏è',
                'coder': 'üë®‚Äçüíª',
                'smart_contract': 'üìù',
                'tester': 'üß™',
                'registry': 'üìã',
                'formal_verification': '‚úÖ',
                'fuzzing_simulation': 'üé≤',
                'documenter': 'üìö',
                'frontend_web3': 'üñ•Ô∏è',
                'communication': 'üì¢',
                'storage': 'üíæ',
                'monitoring': 'üìä',
                'learning': 'üß†',
                'workflow': '‚öôÔ∏è',
                'orchestrator': 'üöÄ'
            },

            async loadAgentConfig(agentId, configPath) {
                if (!configPath) return null;
                try {
                    const cleanPath = configPath.startsWith('/') ? configPath.slice(1) : configPath;
                    const url = `/${cleanPath}?t=${Date.now()}`;
                    
                    const response = await fetch(url);
                    if (!response.ok) return null;
                    
                    const text = await response.text();
                    return jsyaml.load(text);
                } catch (error) {
                    return null;
                }
            },

            extractItems(config, ...paths) {
                if (!config) return { list: [], count: 0 };
                
                let items = null;
                for (const path of paths) {
                    const parts = path.split('.');
                    let current = config;
                    let found = true;
                    
                    for (const part of parts) {
                        if (current && current[part] !== undefined) {
                            current = current[part];
                        } else {
                            found = false;
                            break;
                        }
                    }
                    
                    if (found && current !== undefined) {
                        items = current;
                        break;
                    }
                }
                
                if (!items) return { list: [], count: 0 };
                if (!Array.isArray(items)) return { list: [], count: 0 };
                
                const formattedItems = items.map(item => {
                    if (typeof item === 'string') return item;
                    if (item && typeof item === 'object') {
                        return item.name || item.description || JSON.stringify(item);
                    }
                    return String(item);
                });
                
                return {
                    list: formattedItems,
                    count: formattedItems.length
                };
            },

            extractVersions(config, baseVersion) {
                if (!config) return [];
                
                let versions = [];
                if (config.versions) versions = config.versions;
                else if (config.agent?.versions) versions = config.agent.versions;
                else if (config.version_history) versions = config.version_history;
                
                if (versions && typeof versions === 'object' && !Array.isArray(versions)) {
                    versions = Object.entries(versions).map(([v, data]) => ({
                        version: v,
                        date: data.date || 'N/A',
                        status: data.status || 'stable',
                        changes: data.changes || data.description || 'Mise √† jour'
                    }));
                }
                
                if (Array.isArray(versions)) {
                    versions = versions.map(v => ({
                        version: v.version || v.name || 'N/A',
                        date: v.date || v.release_date || 'N/A',
                        status: v.status || 'stable',
                        changes: v.changes || v.description || v.changelog || 'Mise √† jour'
                    }));
                }
                
                if (!versions || versions.length === 0) {
                    versions = [{
                        version: baseVersion || '1.0.0',
                        date: new Date().toISOString().split('T')[0],
                        status: 'current',
                        changes: 'Version actuelle'
                    }];
                }
                
                return versions;
            },

            extractSubAgents(config) {
                if (!config) return [];
                
                let subAgents = [];
                if (config.agent?.subAgents) subAgents = config.agent.subAgents;
                else if (config.subAgents) subAgents = config.subAgents;
                else if (config.sub_agents) subAgents = config.sub_agents;
                else if (config.children) subAgents = config.children;
                
                return Array.isArray(subAgents) ? subAgents : [];
            },

            async loadAgentWithSubAgents(agentId, baseConfig) {
                const detailConfig = await this.loadAgentConfig(agentId, baseConfig.config_path);
                
                // CAS SP√âCIAL POUR L'ORCHESTRATOR
                if (agentId === 'orchestrator' && detailConfig?.orchestrator) {
                    const orchConfig = detailConfig.orchestrator;
                    
                    const workflowSubAgents = [];
                    if (detailConfig.workflow) {
                        Object.entries(detailConfig.workflow).forEach(([wfName, wfConfig]) => {
                            workflowSubAgents.push({
                                id: `workflow-${wfName}`,
                                icon: '‚öôÔ∏è',
                                name: wfConfig.name || wfName,
                                version: '1.0.0',
                                status: 'active',
                                module: 'workflow',
                                description: wfConfig.description || `Workflow ${wfName}`,
                                capabilities: wfConfig.steps?.length || 0,
                                capabilitiesList: (wfConfig.steps || []).map(s => `√âtape: ${s.task}`),
                                dependencies: [],
                                versions: [{
                                    version: '1.0.0',
                                    date: new Date().toISOString().split('T')[0],
                                    status: 'current',
                                    changes: 'Version actuelle'
                                }],
                                subAgents: []
                            });
                        });
                    }
                    
                    return {
                        id: agentId,
                        icon: this.iconMap[agentId] || 'üöÄ',
                        name: baseConfig.display_name || 'Orchestrateur',
                        version: orchConfig.version || '1.0.0',
                        lastUpdate: new Date().toISOString().split('T')[0],
                        status: 'active',
                        module: baseConfig.config_path?.replace(/\.yaml$/, '') || 'orchestrator',
                        class: 'OrchestratorAgent',
                        description: 'Orchestration des workflows et sprints',
                        
                        capabilities: 5,
                        tools: 0,
                        outputs: 0,
                        rules: 0,
                        limitations: 0,
                        obligations: 0,
                        
                        capabilitiesList: [
                            'WORKFLOW_ORCHESTRATION',
                            'SPRINT_MANAGEMENT',
                            'TASK_SCHEDULING',
                            'RESOURCE_ALLOCATION',
                            'DEADLINE_MANAGEMENT'
                        ],
                        toolsList: [],
                        outputsList: [],
                        rulesList: [],
                        limitationsList: [],
                        obligationsList: [],
                        
                        dependencies: [],
                        versions: [{
                            version: orchConfig.version || '1.0.0',
                            date: new Date().toISOString().split('T')[0],
                            status: 'current',
                            changes: 'Version actuelle'
                        }],
                        subAgents: workflowSubAgents
                    };
                }
                
                // CAS G√âN√âRAL
                const caps = this.extractItems(detailConfig, 
                    'agent.capabilities', 'capabilities', 'agent.capacities', 'capacities');
                const tools = this.extractItems(detailConfig, 
                    'agent.tools', 'tools');
                const outputs = this.extractItems(detailConfig, 
                    'agent.outputs', 'outputs', 'agent.output', 'output');
                const rules = this.extractItems(detailConfig, 
                    'agent.rules', 'rules', 'agent.validation_rules', 'validation_rules');
                const limits = this.extractItems(detailConfig, 
                    'agent.limitations', 'limitations', 'agent.constraints', 'constraints');
                const obls = this.extractItems(detailConfig, 
                    'agent.obligations', 'obligations', 'agent.requirements', 'requirements');
                
                const versions = this.extractVersions(detailConfig, baseConfig.version);
                const subAgentsList = this.extractSubAgents(detailConfig);
                
                const agent = {
                    id: agentId,
                    icon: this.iconMap[agentId] || 'ü§ñ',
                    name: baseConfig.display_name || agentId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    version: baseConfig.version || '1.0.0',
                    lastUpdate: new Date().toISOString().split('T')[0],
                    status: baseConfig.enabled ? 'active' : 'inactive',
                    module: baseConfig.config_path?.replace(/\.yaml$/, '') || 'N/A',
                    class: baseConfig.specialization || '',
                    description: baseConfig.purpose || '',
                    
                    capabilities: caps.count,
                    tools: tools.count,
                    outputs: outputs.count,
                    rules: rules.count,
                    limitations: limits.count,
                    obligations: obls.count,
                    
                    capabilitiesList: caps.list,
                    toolsList: tools.list,
                    outputsList: outputs.list,
                    rulesList: rules.list,
                    limitationsList: limits.list,
                    obligationsList: obls.list,
                    
                    dependencies: baseConfig.dependencies || [],
                    versions: versions,
                    subAgents: []
                };

                // Charger les sous-agents
                if (subAgentsList && subAgentsList.length > 0) {
                    for (let i = 0; i < subAgentsList.length; i++) {
                        const sub = subAgentsList[i];
                        const subId = sub.id || `${agentId}-sub-${i}`;
                        const subBase = {
                            display_name: sub.display_name || sub.name,
                            enabled: sub.enabled !== false,
                            config_path: sub.config_path,
                            dependencies: sub.dependencies || []
                        };
                        
                        const subAgent = await this.loadAgentWithSubAgents(subId, subBase);
                        if (subAgent) {
                            agent.subAgents.push(subAgent);
                        }
                    }
                }
                
                return agent;
            },

            async loadConfig() {
                try {
                    const mainUrl = `/project_config.yaml?t=${Date.now()}`;
                    const mainResp = await fetch(mainUrl);
                    if (!mainResp.ok) throw new Error(`HTTP ${mainResp.status}`);
                    
                    const mainText = await mainResp.text();
                    const mainConfig = jsyaml.load(mainText);

                    if (!mainConfig.agents) {
                        this.agents.mainAgents = [];
                        return;
                    }

                    const agentEntries = Object.entries(mainConfig.agents);
                    this.agents.mainAgents = [];

                    for (const [agentId, agentConfig] of agentEntries) {
                        const agent = await this.loadAgentWithSubAgents(agentId, agentConfig);
                        if (agent) this.agents.mainAgents.push(agent);
                    }
                    
                } catch (error) {
                    throw error;
                }
            },

            generateAgentHTML(agent, level = 0) {
                const subAgents = agent.subAgents || [];
                
                const statusClass = agent.status === 'active' ? 'status-active' : 
                                   (agent.status === 'beta' ? 'status-beta' : 'status-inactive');
                const statusText = agent.status === 'active' ? '‚úÖ Actif' : 
                                  (agent.status === 'beta' ? 'üß™ B√™ta' : '‚ùå Inactif');

                let html = `
                    <div class="agent-node">
                        <div class="agent-header" onclick="AgentManager.toggleAgent(this)">
                            <span class="agent-icon">${agent.icon}</span>
                            <div class="agent-info">
                                <div class="agent-name-line">
                                    <span class="agent-name">${agent.name}</span>
                                    <span class="agent-version">v${agent.version}</span>
                                    <span class="agent-status ${statusClass}">${statusText}</span>
                                </div>
                                <div class="agent-meta">
                                    <span class="badge badge-capability">${agent.capabilities} capacit√©s</span>
                                    <span class="badge badge-tool">${agent.tools} outils</span>
                                    <span class="badge badge-output">${agent.outputs} outputs</span>
                                    <span class="badge badge-rule">${agent.rules} r√®gles</span>
                                    <span class="badge badge-dependency">${agent.dependencies.length} d√©pendances</span>
                                    ${subAgents.length > 0 ? `<span class="badge badge-subagent">${subAgents.length} sous-agent(s)</span>` : ''}
                                    <span>${agent.description}</span>
                                </div>
                            </div>
                            <span class="expand-icon">‚ñ∂</span>
                        </div>
                        <div class="agent-detail">
                            <div class="identity-card">
                                <h4>üìã Fiche d'identit√©</h4>
                                <div class="identity-grid">
                                    <div><span class="identity-label">Nom technique</span> ${agent.id}</div>
                                    <div><span class="identity-label">Version</span> ${agent.version}</div>
                                    <div><span class="identity-label">Module</span> ${agent.module}</div>
                                    <div><span class="identity-label">Type</span> ${agent.class || 'N/A'}</div>
                                    <div><span class="identity-label">Statut</span> ${statusText}</div>
                                </div>
                            </div>
                `;
                
                // Dictionnaire des versions
                if (agent.versions && agent.versions.length > 0) {
                    html += `
                        <div class="versions-dict">
                            <h4>üìö Dictionnaire des versions</h4>
                            <table class="versions-table">
                                <thead>
                                    <tr>
                                        <th>Version</th>
                                        <th>Date</th>
                                        <th>Statut</th>
                                        <th>Changements</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${agent.versions.map(v => `
                                        <tr>
                                            <td><strong>${v.version}</strong> ${v.status === 'current' ? '<span class="version-current">actuelle</span>' : ''}</td>
                                            <td>${v.date}</td>
                                            <td>${v.status}</td>
                                            <td>${v.changes}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                // Capacit√©s
                if (agent.capabilitiesList && agent.capabilitiesList.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>‚ö° Capacit√©s (${agent.capabilities})</h4>
                            <ul class="detail-list">${agent.capabilitiesList.map(c => `<li>${c}</li>`).join('')}</ul>
                        </div>
                    `;
                }
                
                // Outils
                if (agent.toolsList && agent.toolsList.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>üõ†Ô∏è Outils (${agent.tools})</h4>
                            <ul class="detail-list">${agent.toolsList.map(t => `<li>${t}</li>`).join('')}</ul>
                        </div>
                    `;
                }
                
                // Outputs
                if (agent.outputsList && agent.outputsList.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>üì§ Outputs (${agent.outputs})</h4>
                            <ul class="detail-list">${agent.outputsList.map(o => `<li>${o}</li>`).join('')}</ul>
                        </div>
                    `;
                }
                
                // R√®gles
                if (agent.rulesList && agent.rulesList.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>‚öñÔ∏è R√®gles (${agent.rules})</h4>
                            <ul class="detail-list">${agent.rulesList.map(r => `<li>${r}</li>`).join('')}</ul>
                        </div>
                    `;
                }
                
                // Limitations
                if (agent.limitationsList && agent.limitationsList.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>üö´ Limitations (${agent.limitations})</h4>
                            <ul class="detail-list">${agent.limitationsList.map(l => `<li>${l}</li>`).join('')}</ul>
                        </div>
                    `;
                }
                
                // Obligations
                if (agent.obligationsList && agent.obligationsList.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>üìã Obligations (${agent.obligations})</h4>
                            <ul class="detail-list">${agent.obligationsList.map(o => `<li>${o}</li>`).join('')}</ul>
                        </div>
                    `;
                }
                
                // D√©pendances
                if (agent.dependencies && agent.dependencies.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>üîó D√©pendances</h4>
                            <div class="dependencies-list">${agent.dependencies.map(d => `<span class="dependency-item">${d}</span>`).join('')}</div>
                        </div>
                    `;
                }
                
                // === SOUS-AGENTS COMPACTS ===
                if (subAgents.length > 0) {
                    html += `
                        <div class="detail-section">
                            <h4>üì¶ Sous-agents (${subAgents.length})</h4>
                            <div class="sub-agents-compact">
                                ${subAgents.map(sub => {
                                    const subStatusClass = sub.status === 'active' ? 'status-active' : 
                                                          (sub.status === 'beta' ? 'status-beta' : 'status-inactive');
                                    return `
                                        <div class="compact-subagent">
                                            <div class="agent-header" onclick="event.stopPropagation(); AgentManager.toggleAgent(this)">
                                                <span class="agent-icon" style="font-size: 16px;">${sub.icon}</span>
                                                <div class="agent-info">
                                                    <div class="agent-name-line" style="margin-bottom: 0;">
                                                        <span class="agent-name" style="font-size: 14px;">${sub.name}</span>
                                                        <span class="agent-version" style="font-size: 10px;">v${sub.version}</span>
                                                        <span class="agent-status ${subStatusClass}" style="font-size: 10px; padding: 2px 6px;">
                                                            ${sub.status === 'active' ? '‚úÖ' : (sub.status === 'beta' ? 'üß™' : '‚ùå')}
                                                        </span>
                                                    </div>
                                                    <div class="agent-meta" style="font-size: 11px; gap: 5px;">
                                                        <span class="badge badge-capability" style="font-size: 9px;">${sub.capabilities} cap.</span>
                                                        <span>${sub.description}</span>
                                                    </div>
                                                </div>
                                                <span class="expand-icon" style="font-size: 14px;">‚ñ∂</span>
                                            </div>
                                            <div class="agent-detail" style="padding: 10px;">
                                                <div class="identity-card" style="padding: 10px; margin-bottom: 10px;">
                                                    <div class="identity-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                                                        <div><span class="identity-label">Version</span> ${sub.version}</div>
                                                        <div><span class="identity-label">Module</span> ${sub.module || 'N/A'}</div>
                                                    </div>
                                                </div>
                                                ${sub.capabilitiesList && sub.capabilitiesList.length > 0 ? `
                                                    <div class="detail-section" style="margin-bottom: 10px;">
                                                        <h5>‚ö° Capacit√©s</h5>
                                                        <ul class="detail-list" style="grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 5px;">
                                                            ${sub.capabilitiesList.slice(0, 3).map(c => `<li style="font-size: 11px; padding: 4px 8px;">${c}</li>`).join('')}
                                                            ${sub.capabilitiesList.length > 3 ? `<li style="font-size: 11px; padding: 4px 8px;">... et ${sub.capabilitiesList.length - 3} autres</li>` : ''}
                                                        </ul>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                
                html += `</div></div>`;
                return html;
            },

            async render() {
                const container = document.getElementById('agents-container');
                container.innerHTML = '<div class="loading">Chargement des agents...</div>';
                
                try {
                    await this.loadConfig();
                    
                    let html = '';
                    this.agents.mainAgents.forEach(agent => {
                        html += this.generateAgentHTML(agent, 0);
                    });
                    
                    container.innerHTML = html;
                    this.updateStats();
                    
                } catch (error) {
                    container.innerHTML = `<div class="error">‚ùå Erreur: ${error.message}</div>`;
                }
            },

            updateStats() {
                let main = this.agents.mainAgents.length;
                let sub = 0, caps = 0, tools = 0, outputs = 0, rules = 0, deps = 0;
                
                const count = (agents) => {
                    agents.forEach(a => {
                        caps += a.capabilities;
                        tools += a.tools;
                        outputs += a.outputs;
                        rules += a.rules;
                        deps += a.dependencies.length;
                        if (a.subAgents && a.subAgents.length) {
                            sub += a.subAgents.length;
                            count(a.subAgents);
                        }
                    });
                };
                
                count(this.agents.mainAgents);
                
                const setText = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                };
                
                setText('stats-main-agents', main);
                setText('stats-sub-agents', sub);
                setText('stats-capacities', caps);
                setText('stats-tools', tools);
                setText('stats-outputs', outputs);
                setText('stats-rules', rules);
                setText('stats-active', main + sub);
                setText('last-update', new Date().toLocaleString('fr-FR'));
                
                const subtitle = document.getElementById('header-subtitle');
                if (subtitle) subtitle.innerHTML = `${main} agents ‚Ä¢ ${sub} sous-agents ‚Ä¢ ${deps} d√©pendances`;
            },

            toggleAgent(header) {
                header.classList.toggle('expanded');
                const detail = header.nextElementSibling;
                if (detail?.classList.contains('agent-detail')) {
                    detail.classList.toggle('visible');
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => AgentManager.render());
    </script>
</body>
</html>